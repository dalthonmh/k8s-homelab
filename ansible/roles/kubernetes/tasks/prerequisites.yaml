---
# Step 1. Disabling swap
# tasks file for disable-swap
- name: Check if swap is enabled
  command: swapon --summary
  register: swap_status
  changed_when: swap_status.stdout != ''

- name: Disable swap immediately
  command: swapoff -a
  when: swap_status.stdout != ''
  register: swapoff_result

- name: Ensure swap is commented out in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: "^(?!#)(.*swap.*)$"
    replace: '# \1'
  register: replace_status

- name: daemon_reload
  command: systemctl daemon-reload
  register: reload_status
  notify: feedback_handler
  when: replace_status.changed

---
# Step 2. Install and configure prerequisites
# Enable IPv4 packet forwarding and bridge netfilter
- name: Load necessary kernel modules
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      overlay
      br_netfilter
  become: true

- name: Apply sysctl settings
  copy:
    dest: /etc/sysctl.d/k8s.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
  become: true

- name: Reload sysctl settings
  command: sysctl --system
  become: true
